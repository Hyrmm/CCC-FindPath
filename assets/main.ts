/*
 * @Author: hyrm 
 * @Date: 2024-04-27 17:10:42 
 * @Last Modified by: hyrm
 * @Last Modified time: 2024-04-30 18:25:21
 */

const { ccclass, property } = cc._decorator
import earcut from "earcut"
import { QuadTree, QuadTreeObject, QuadTreeRect } from './script/dataStructure/QuadTree'
import { AStarGraph, Triangle } from './script/algorithm/AStarGraph'
import { flatVertexs2Vec2, getCommonVertexs } from './script/utils/Utils'
import { Entity } from './script/components/EntityContainer'
import EntityContainer from './script/components/EntityContainer'
import { AStarGridMesh, MapData, Block } from "./script/algorithm/AStarGridMesh"
@ccclass
export default class Main extends cc.Component {

    @property(cc.Node)
    viewPort: cc.Node = null

    @property(cc.Node)
    mapContainer: cc.Node = null

    @property(cc.Node)
    entityContainer: cc.Node = null

    @property(cc.Node)
    graphicsContainer: cc.Node = null

    @property(cc.Node)
    entity_start: cc.Node = null

    @property(cc.Node)
    entity_end: cc.Node = null

    graphics_path: cc.Graphics = null
    graphics_mesh: cc.Graphics = null

    private entityContainerCom: EntityContainer

    private isTouching: boolean = false
    private mapQuadTree: QuadTree<tileMapData> = null
    private mapQuadSize: number = 16

    private mapOriSize: { width: number, height: number } = { width: 1024 * 7, height: 1024 * 4 }
    private mapTileSize: { width: number, height: number } = { width: 1024 * 7 / 16, height: 1024 * 4 / 16 }


    private astarGraph: AStarGraph = null
    private astarGraphMesh: AStarGridMesh = null


    protected start() {
        this.entityContainerCom = this.entityContainer.getComponent(EntityContainer)

        this.graphics_path = this.graphicsContainer.getChildByName("path_graphics").getComponent(cc.Graphics)
        this.graphics_mesh = this.graphicsContainer.getChildByName("mesh_graphics").getComponent(cc.Graphics)

        console.time("init")
        // 地图触摸相关事件监听
        this.initTouchEventListener()
        console.timeEnd("init")

        console.time("QuadTree")
        // 四叉树初始化(用于动态加载可视区域显示地图)
        this.initTileMapQuadTree()
        console.timeEnd("QuadTree")

        console.time("meshGraph")
        // 寻路网格初始化(用于寻路算法)
        this.initTriangleNavMeshGraph()
        console.timeEnd("meshGraph")

        // 首次地图可视范围更新
        this.updateViewPortMapTileNodes()
        cc.resources.load("mapData", cc.JsonAsset, (err, data) => {
            const astarGraph = new AStarGridMesh(data.json as MapData)
            this.astarGraphMesh = astarGraph
            const ctx = this.graphics_mesh

            ctx.strokeColor = cc.color(0, 0, 0, 100)
            // rows
            for (let i = 1; i < this.mapOriSize.height / 32; i++) {
                const startPos = cc.v2(0 - this.mapOriSize.width / 2, i * 32 - this.mapOriSize.height / 2)
                const endPos = cc.v2(this.mapOriSize.width - this.mapOriSize.width / 2, i * 32 - this.mapOriSize.height / 2)

                ctx.moveTo(startPos.x, startPos.y)
                ctx.lineTo(endPos.x, endPos.y)
                ctx.stroke()
            }

            // lines
            for (let i = 1; i < this.mapOriSize.width / 32; i++) {
                const startPos = cc.v2(i * 32 - this.mapOriSize.width / 2, 0 - this.mapOriSize.height / 2)
                const endPos = cc.v2(i * 32 - this.mapOriSize.width / 2, this.mapOriSize.height - this.mapOriSize.height / 2)

                ctx.moveTo(startPos.x, startPos.y)
                ctx.lineTo(endPos.x, endPos.y)
                ctx.stroke()

            }


            for (const block of astarGraph.getAllBlocks()) {
                
            }


        })



    }



    private initTouchEventListener() {
        let isPlacingEnd = false
        let isPlacingRole = false

        this.viewPort.on(cc.Node.EventType.TOUCH_MOVE, (event: cc.Event.EventTouch) => {
            if (!this.isTouching) return

            const delta = event.touch.getDelta()

            // 边界判断,因项目适配宽度,不同设备高度不同,这里取屏幕高度做判断
            const changePosY = this.mapContainer.y + delta.y
            const changePosX = this.mapContainer.x + delta.x

            if (Math.abs(changePosX) <= this.mapOriSize.width / 2 - this.viewPort.width / 2) {
                this.mapContainer.x = changePosX
                this.entityContainer.x = changePosX
                this.graphicsContainer.x = changePosX
            }

            if (Math.abs(changePosY) <= this.mapOriSize.height / 2 - this.viewPort.height / 2) {
                this.mapContainer.y = changePosY
                this.entityContainer.y = changePosY
                this.graphicsContainer.y = changePosY
            }

            this.updateViewPortMapTileNodes()

        }, this)

        this.viewPort.on(cc.Node.EventType.TOUCH_START, (event: cc.Event.EventTouch) => {
            this.isTouching = true

            const mapPos = this.mapContainer.convertToNodeSpaceAR(event.getLocation())
            const blockPos = this.astarGraphMesh.getBlockByPos(mapPos)
            const entityPos = this.entity_start.getPosition()

            this.node.getChildByName("fixed").getChildByName("lbl_pos").getComponent(cc.Label).string = `(${Math.ceil(mapPos.x)},${Math.ceil(mapPos.y)})\n(${blockPos.x},${blockPos.y})`

            console.time("gridMesh")
            console.log(mapPos)
            const result = this.astarGraphMesh.findPath(entityPos, cc.v2(Math.ceil(mapPos.x), Math.ceil(mapPos.y)))
            console.timeEnd("gridMesh")
            console.log(result)
            this.drawRect(this.graphics_path, result)


            if (isPlacingEnd) isPlacingEnd = false
            if (isPlacingRole) isPlacingRole = false

        }, this)

        this.viewPort.on(cc.Node.EventType.TOUCH_END, (event: cc.Event.EventTouch) => {
            this.isTouching = false
        }, this)

        this.viewPort.on(cc.Node.EventType.TOUCH_CANCEL, (event: cc.Event.EventTouch) => {
            this.isTouching = false
        }, this)

        this.viewPort.on(cc.Node.EventType.MOUSE_MOVE, (event: cc.Event.EventMouse) => {
            const mapPos = this.mapContainer.convertToNodeSpaceAR(event.getLocation())
            if (isPlacingEnd) {
                this.entity_end.x = Math.ceil(mapPos.x)
                this.entity_end.y = Math.ceil(mapPos.y)
            }

            if (isPlacingRole) {
                this.entity_start.x = Math.ceil(mapPos.x)
                this.entity_start.y = Math.ceil(mapPos.y)
            }

        })

        this.entity_end.on(cc.Node.EventType.TOUCH_START, (event: cc.Event.EventTouch) => {
            if (isPlacingEnd) {
                const start = new cc.Vec2(this.entity_start.x, this.entity_start.y)
                const end = new cc.Vec2(this.entity_end.x, this.entity_end.y)

                const pathGraphics = this.graphicsContainer.getChildByName("path_graphics").getComponent(cc.Graphics)
                pathGraphics.clear()

                console.time("triangleMesh")
                const path = this.astarGraph.findTrianglePath(start, end)
                console.timeEnd("triangleMesh")
                for (const triangle of path.trianglesPath) {
                    this.drawTriangle(pathGraphics, triangle, cc.Color.GREEN)
                }

                this.entityContainerCom.addShadowPos(this.entity_start.name, path.pointsPath.concat([end]))

                path.pointsPath.push(end)
                path.pointsPath.unshift(start)
                this.drawLine(pathGraphics, path.pointsPath)
                this.drawLine(pathGraphics, path.apexPath, cc.Color.BLUE)

                console.time("gridMesh")
                const result = this.astarGraphMesh.findPath(start, end)
                console.timeEnd("gridMesh")
                console.log(result)
                this.drawRect(pathGraphics, result)

            }
            isPlacingEnd = !isPlacingEnd
        })

        this.entity_start.on(cc.Node.EventType.TOUCH_START, (event: cc.Event.EventTouch) => {
            isPlacingRole = !isPlacingRole
        })

    }

    private initTileMapQuadTree() {

        const boundsPosX = -this.mapOriSize.width / 2
        const boundsPosY = -this.mapOriSize.height / 2
        const boundsWidth = this.mapOriSize.width
        const boundsHeight = this.mapOriSize.height

        const rootBounds: QuadTreeRect = { x: boundsPosX, y: boundsPosY, width: boundsWidth, height: boundsHeight }
        this.mapQuadTree = new QuadTree<tileMapData>(rootBounds, 4)

        for (let i = 0; i < Math.pow(this.mapQuadSize, 2); i++) {

            const rows = Math.floor(i / this.mapQuadSize) + 1
            const cols = i % this.mapQuadSize + 1

            // 建立基于地图节点相对地图块坐标
            const tileNode = new cc.Node(`tile_${i}`)
            const halfTileWidth = this.mapTileSize.width / 2
            const halfTileHeight = this.mapTileSize.height / 2
            const tilePosX = cols <= this.mapQuadSize / 2 ? -((this.mapQuadSize / 2 - cols) * this.mapTileSize.width + halfTileWidth) : (cols - (this.mapQuadSize / 2 + 1)) * this.mapTileSize.width + halfTileWidth
            const tilePosY = rows <= this.mapQuadSize / 2 ? (this.mapQuadSize / 2 - rows) * this.mapTileSize.height + halfTileHeight : -((rows - (this.mapQuadSize / 2 + 1)) * this.mapTileSize.height + halfTileHeight)
            tileNode.setPosition(tilePosX, tilePosY)
            tileNode.setAnchorPoint(0.5, 0.5)
            this.mapContainer.addChild(tileNode)

            // 建立基于世界坐标碰撞矩形
            const tileBoundsX = this.mapQuadTree.bounds.x + (cols - 1) * this.mapTileSize.width
            const tileBoundsY = this.mapQuadTree.bounds.y + (this.mapQuadSize - 1 - (rows - 1)) * this.mapTileSize.height
            const tileRect: QuadTreeRect = { x: tileBoundsX, y: tileBoundsY, width: this.mapTileSize.width, height: this.mapTileSize.height }
            const quadTreeObject: tileMapData = { owningRect: tileRect, node: tileNode }

            // 绑定碰撞矩形和地图块节点插入四叉树中
            this.mapQuadTree.insert(tileRect, quadTreeObject)
        }
    }

    private initTriangleNavMeshGraph() {
        const polygonVerticesFlat = [
            -3558.5,
            -772,
            -3558.5,
            -772,
            -3558.5,
            -772,
            -3432.5,
            -712,
            -3432.5,
            -712,
            -3432.5,
            -712,
            -3401,
            -653.5,
            -3401,
            -653.5,
            -3401,
            -653.5,
            -3270.5,
            -659.5,
            -3270.5,
            -659.5,
            -3270.5,
            -659.5,
            -3174.5,
            -629.5,
            -3174.5,
            -629.5,
            -3174.5,
            -629.5,
            -3051.5,
            -611.5,
            -3051.5,
            -611.5,
            -3051.5,
            -611.5,
            -3098,
            -547,
            -3098,
            -547,
            -3098,
            -547,
            -3167,
            -488.5,
            -3167,
            -488.5,
            -3167,
            -488.5,
            -3162.5,
            -472,
            -3162.5,
            -472,
            -3162.5,
            -472,
            -3074,
            -473.5,
            -3074,
            -473.5,
            -3074,
            -473.5,
            -2948,
            -484,
            -2948,
            -484,
            -2948,
            -484,
            -2846,
            -494.5,
            -2846,
            -494.5,
            -2846,
            -494.5,
            -2825,
            -505,
            -2825,
            -505,
            -2825,
            -505,
            -2895.5,
            -442,
            -2895.5,
            -442,
            -2895.5,
            -442,
            -2961.5,
            -425.5,
            -2961.5,
            -425.5,
            -2961.5,
            -425.5,
            -3036.5,
            -419.5,
            -3036.5,
            -419.5,
            -3036.5,
            -419.5,
            -3122,
            -403,
            -3122,
            -403,
            -3122,
            -403,
            -3221,
            -392.5,
            -3221,
            -392.5,
            -3221,
            -392.5,
            -3260,
            -383.5,
            -3260,
            -383.5,
            -3260,
            -383.5,
            -3284,
            -443.5,
            -3284,
            -443.5,
            -3284,
            -443.5,
            -3311,
            -484,
            -3311,
            -484,
            -3311,
            -484,
            -3350,
            -508,
            -3350,
            -508,
            -3350,
            -508,
            -3371,
            -529,
            -3371,
            -529,
            -3371,
            -529,
            -3455,
            -529,
            -3455,
            -529,
            -3455,
            -529,
            -3480.5,
            -529,
            -3480.5,
            -529,
            -3480.5,
            -529,
            -3470,
            -590.5,
            -3470,
            -590.5,
            -3470,
            -590.5,
            -3545,
            -659.5,
            -3545,
            -659.5,
            -3545,
            -659.5,
            -3578,
            -629.5,
            -3578,
            -629.5,
            -3578,
            -629.5,
            -3569,
            -503.5,
            -3569,
            -503.5,
            -3569,
            -503.5,
            -3576.5,
            -433,
            -3576.5,
            -433,
            -3576.5,
            -433,
            -3507.5,
            -464.5,
            -3507.5,
            -464.5,
            -3507.5,
            -464.5,
            -3423.5,
            -422.5,
            -3423.5,
            -422.5,
            -3423.5,
            -422.5,
            -3402.5,
            -368.5,
            -3402.5,
            -368.5,
            -3402.5,
            -368.5,
            -3444.5,
            -344.5,
            -3444.5,
            -344.5,
            -3444.5,
            -344.5,
            -3378.5,
            -293.5,
            -3378.5,
            -293.5,
            -3378.5,
            -293.5,
            -3224,
            -337,
            -3224,
            -337,
            -3224,
            -337,
            -3117.5,
            -344.5,
            -3117.5,
            -344.5,
            -3117.5,
            -344.5,
            -2982.5,
            -359.5,
            -2982.5,
            -359.5,
            -2982.5,
            -359.5,
            -2880.5,
            -374.5,
            -2880.5,
            -374.5,
            -2880.5,
            -374.5,
            -2796.5,
            -434.5,
            -2796.5,
            -434.5,
            -2796.5,
            -434.5,
            -2808.5,
            -400,
            -2808.5,
            -400,
            -2808.5,
            -400,
            -2952.5,
            -344.5,
            -2952.5,
            -344.5,
            -2952.5,
            -344.5,
            -3084.5,
            -329.5,
            -3084.5,
            -329.5,
            -3084.5,
            -329.5,
            -3177.5,
            -320.5,
            -3177.5,
            -320.5,
            -3177.5,
            -320.5,
            -3276.5,
            -305.5,
            -3276.5,
            -305.5,
            -3276.5,
            -305.5,
            -3365,
            -259,
            -3365,
            -259,
            -3365,
            -259,
            -3287,
            -223,
            -3287,
            -223,
            -3287,
            -223,
            -3105.5,
            -187,
            -3105.5,
            -187,
            -3105.5,
            -187,
            -2979.5,
            -146.5,
            -2979.5,
            -146.5,
            -2979.5,
            -146.5,
            -2838.5,
            -109,
            -2838.5,
            -109,
            -2838.5,
            -109,
            -2706.5,
            -106,
            -2706.5,
            -106,
            -2706.5,
            -106,
            -2654,
            -109,
            -2654,
            -109,
            -2654,
            -109,
            -2619.5,
            -167.5,
            -2619.5,
            -167.5,
            -2619.5,
            -167.5,
            -2493.5,
            -332.5,
            -2493.5,
            -332.5,
            -2493.5,
            -332.5,
            -2453,
            -340,
            -2453,
            -340,
            -2453,
            -340,
            -2378,
            -254.5,
            -2378,
            -254.5,
            -2378,
            -254.5,
            -2291,
            -263.5,
            -2291,
            -263.5,
            -2291,
            -263.5,
            -2256.5,
            -335.5,
            -2256.5,
            -335.5,
            -2256.5,
            -335.5,
            -2154.5,
            -335.5,
            -2154.5,
            -335.5,
            -2154.5,
            -335.5,
            -2034.5,
            -367,
            -2034.5,
            -367,
            -2034.5,
            -367,
            -1916,
            -314.5,
            -1916,
            -314.5,
            -1916,
            -314.5,
            -1896.5,
            -242.5,
            -1896.5,
            -242.5,
            -1896.5,
            -242.5,
            -1992.5,
            -113.5,
            -1992.5,
            -113.5,
            -1992.5,
            -113.5,
            -1899.5,
            -65.5,
            -1899.5,
            -65.5,
            -1899.5,
            -65.5,
            -1824.5,
            -206.5,
            -1824.5,
            -206.5,
            -1824.5,
            -206.5,
            -1802,
            -278.5,
            -1802,
            -278.5,
            -1802,
            -278.5,
            -1785.5,
            -386.5,
            -1785.5,
            -386.5,
            -1785.5,
            -386.5,
            -1694,
            -520,
            -1694,
            -520,
            -1694,
            -520,
            -1551.5,
            -392.5,
            -1551.5,
            -392.5,
            -1551.5,
            -392.5,
            -1382,
            -436,
            -1382,
            -436,
            -1382,
            -436,
            -1251.5,
            -373,
            -1251.5,
            -373,
            -1251.5,
            -373,
            -1125.5,
            -445,
            -1125.5,
            -445,
            -1125.5,
            -445,
            -1001,
            -458.5,
            -1001,
            -458.5,
            -1001,
            -458.5,
            -794,
            -470.5,
            -794,
            -470.5,
            -794,
            -470.5,
            -617,
            -385,
            -617,
            -385,
            -617,
            -385,
            -521,
            -259,
            -521,
            -259,
            -521,
            -259,
            -462.5,
            -172,
            -462.5,
            -172,
            -462.5,
            -172,
            -338,
            -139,
            -338,
            -139,
            -338,
            -139,
            -393.5,
            -28,
            -393.5,
            -28,
            -393.5,
            -28,
            -423.5,
            80,
            -423.5,
            80,
            -423.5,
            80,
            -489.5,
            146,
            -489.5,
            146,
            -489.5,
            146,
            -641,
            183.5,
            -641,
            183.5,
            -641,
            183.5,
            -770,
            192.5,
            -770,
            192.5,
            -770,
            192.5,
            -884,
            176,
            -884,
            176,
            -884,
            176,
            -1062.5,
            183.5,
            -1062.5,
            183.5,
            -1062.5,
            183.5,
            -1215.5,
            192.5,
            -1215.5,
            192.5,
            -1215.5,
            192.5,
            -1376,
            194,
            -1376,
            194,
            -1376,
            194,
            -1509.5,
            177.5,
            -1509.5,
            177.5,
            -1509.5,
            177.5,
            -1632.5,
            150.5,
            -1632.5,
            150.5,
            -1632.5,
            150.5,
            -1751,
            120.5,
            -1751,
            120.5,
            -1751,
            120.5,
            -1907,
            89,
            -1907,
            89,
            -1907,
            89,
            -2055.5,
            47,
            -2055.5,
            47,
            -2055.5,
            47,
            -2243,
            12.5,
            -2243,
            12.5,
            -2243,
            12.5,
            -2402,
            2,
            -2402,
            2,
            -2402,
            2,
            -2535.5,
            21.5,
            -2535.5,
            21.5,
            -2535.5,
            21.5,
            -2759,
            41,
            -2759,
            41,
            -2759,
            41,
            -2874.5,
            41,
            -2874.5,
            41,
            -2874.5,
            41,
            -2909,
            86,
            -2909,
            86,
            -2909,
            86,
            -2970.5,
            92,
            -2970.5,
            92,
            -2970.5,
            92,
            -2988.5,
            68,
            -2988.5,
            68,
            -2988.5,
            68,
            -2961.5,
            12.5,
            -2961.5,
            12.5,
            -2961.5,
            12.5,
            -3032,
            -25,
            -3032,
            -25,
            -3032,
            -25,
            -3125,
            -43,
            -3125,
            -43,
            -3125,
            -43,
            -3242,
            -62.5,
            -3242,
            -62.5,
            -3242,
            -62.5,
            -3404,
            -85,
            -3404,
            -85,
            -3404,
            -85,
            -3504.5,
            -95.5,
            -3504.5,
            -95.5,
            -3504.5,
            -95.5,
            -3566,
            -91,
            -3566,
            -91,
            -3566,
            -91,
            -3576.5,
            15.5,
            -3576.5,
            15.5,
            -3576.5,
            15.5,
            -3569,
            87.5,
            -3569,
            87.5,
            -3569,
            87.5,
            -3521,
            117.5,
            -3521,
            117.5,
            -3521,
            117.5,
            -3297.5,
            98,
            -3297.5,
            98,
            -3297.5,
            98,
            -3162.5,
            140,
            -3162.5,
            140,
            -3162.5,
            140,
            -3120.5,
            116,
            -3120.5,
            116,
            -3120.5,
            116,
            -3072.5,
            84.5,
            -3072.5,
            84.5,
            -3072.5,
            84.5,
            -3032,
            110,
            -3032,
            110,
            -3032,
            110,
            -3026,
            158,
            -3026,
            158,
            -3026,
            158,
            -2847.5,
            170,
            -2847.5,
            170,
            -2847.5,
            170,
            -2715.5,
            162.5,
            -2715.5,
            162.5,
            -2715.5,
            162.5,
            -2535.5,
            170,
            -2535.5,
            170,
            -2535.5,
            170,
            -2394.5,
            179,
            -2394.5,
            179,
            -2394.5,
            179,
            -2309,
            183.5,
            -2309,
            183.5,
            -2309,
            183.5,
            -2307.5,
            269,
            -2307.5,
            269,
            -2307.5,
            269,
            -2249,
            273.5,
            -2249,
            273.5,
            -2249,
            273.5,
            -2201,
            176,
            -2201,
            176,
            -2201,
            176,
            -2144,
            192.5,
            -2144,
            192.5,
            -2144,
            192.5,
            -2114,
            291.5,
            -2114,
            291.5,
            -2114,
            291.5,
            -2144,
            350,
            -2144,
            350,
            -2144,
            350,
            -2247.5,
            350,
            -2247.5,
            350,
            -2247.5,
            350,
            -2354,
            396.5,
            -2354,
            396.5,
            -2354,
            396.5,
            -2408,
            500,
            -2408,
            500,
            -2408,
            500,
            -2379.5,
            564.5,
            -2379.5,
            564.5,
            -2379.5,
            564.5,
            -2328.5,
            618.5,
            -2328.5,
            618.5,
            -2328.5,
            618.5,
            -2183,
            645.5,
            -2183,
            645.5,
            -2183,
            645.5,
            -2049.5,
            639.5,
            -2049.5,
            639.5,
            -2049.5,
            639.5,
            -1934,
            630.5,
            -1934,
            630.5,
            -1934,
            630.5,
            -1794.5,
            615.5,
            -1794.5,
            615.5,
            -1794.5,
            615.5,
            -1688,
            590,
            -1688,
            590,
            -1688,
            590,
            -1650.5,
            555.5,
            -1650.5,
            555.5,
            -1650.5,
            555.5,
            -1640,
            488,
            -1640,
            488,
            -1640,
            488,
            -1638.5,
            411.5,
            -1638.5,
            411.5,
            -1638.5,
            411.5,
            -1620.5,
            339.5,
            -1620.5,
            339.5,
            -1620.5,
            339.5,
            -1530.5,
            285.5,
            -1530.5,
            285.5,
            -1530.5,
            285.5,
            -1464.5,
            290,
            -1464.5,
            290,
            -1464.5,
            290,
            -1425.5,
            371,
            -1425.5,
            371,
            -1425.5,
            371,
            -1338.5,
            404,
            -1338.5,
            404,
            -1338.5,
            404,
            -1260.5,
            404,
            -1260.5,
            404,
            -1260.5,
            404,
            -1236.5,
            303.5,
            -1236.5,
            303.5,
            -1236.5,
            303.5,
            -1190,
            305,
            -1190,
            305,
            -1190,
            305,
            -1076,
            372.5,
            -1076,
            372.5,
            -1076,
            372.5,
            -980,
            390.5,
            -980,
            390.5,
            -980,
            390.5,
            -858.5,
            441.5,
            -858.5,
            441.5,
            -858.5,
            441.5,
            -725,
            459.5,
            -725,
            459.5,
            -725,
            459.5,
            -668,
            425,
            -668,
            425,
            -668,
            425,
            -579.5,
            462.5,
            -579.5,
            462.5,
            -579.5,
            462.5,
            -393.5,
            482,
            -393.5,
            482,
            -393.5,
            482,
            -434,
            569,
            -434,
            569,
            -434,
            569,
            -528.5,
            606.5,
            -528.5,
            606.5,
            -528.5,
            606.5,
            -677,
            608,
            -677,
            608,
            -677,
            608,
            -785,
            599,
            -785,
            599,
            -785,
            599,
            -893,
            555.5,
            -893,
            555.5,
            -893,
            555.5,
            -1007,
            546.5,
            -1007,
            546.5,
            -1007,
            546.5,
            -1091,
            647,
            -1091,
            647,
            -1091,
            647,
            -1266.5,
            621.5,
            -1266.5,
            621.5,
            -1266.5,
            621.5,
            -1295,
            669.5,
            -1295,
            669.5,
            -1295,
            669.5,
            -1400,
            620,
            -1400,
            620,
            -1400,
            620,
            -1508,
            632,
            -1508,
            632,
            -1508,
            632,
            -1404.5,
            705.5,
            -1404.5,
            705.5,
            -1404.5,
            705.5,
            -1430,
            771.5,
            -1430,
            771.5,
            -1430,
            771.5,
            -1503.5,
            803,
            -1503.5,
            803,
            -1503.5,
            803,
            -1620.5,
            764,
            -1620.5,
            764,
            -1620.5,
            764,
            -1649,
            828.5,
            -1649,
            828.5,
            -1649,
            828.5,
            -1497.5,
            857,
            -1497.5,
            857,
            -1497.5,
            857,
            -1433,
            923,
            -1433,
            923,
            -1433,
            923,
            -1355,
            975.5,
            -1355,
            975.5,
            -1355,
            975.5,
            -1209.5,
            1016,
            -1209.5,
            1016,
            -1209.5,
            1016,
            -1092.5,
            1035.5,
            -1092.5,
            1035.5,
            -1092.5,
            1035.5,
            -957.5,
            1017.5,
            -957.5,
            1017.5,
            -957.5,
            1017.5,
            -807.5,
            1008.5,
            -807.5,
            1008.5,
            -807.5,
            1008.5,
            -684.5,
            981.5,
            -684.5,
            981.5,
            -684.5,
            981.5,
            -588.5,
            966.5,
            -588.5,
            966.5,
            -588.5,
            966.5,
            -464,
            924.5,
            -464,
            924.5,
            -464,
            924.5,
            -308,
            926,
            -308,
            926,
            -308,
            926,
            -191,
            933.5,
            -191,
            933.5,
            -191,
            933.5,
            -147.5,
            936.5,
            -147.5,
            936.5,
            -147.5,
            936.5,
            -30.5,
            929,
            -30.5,
            929,
            -30.5,
            929,
            50.5,
            890,
            50.5,
            890,
            50.5,
            890,
            98.5,
            839,
            98.5,
            839,
            98.5,
            839,
            166,
            746,
            166,
            746,
            166,
            746,
            244,
            711.5,
            244,
            711.5,
            244,
            711.5,
            362.5,
            705.5,
            362.5,
            705.5,
            362.5,
            705.5,
            482.5,
            692,
            482.5,
            692,
            482.5,
            692,
            559,
            659,
            559,
            659,
            559,
            659,
            616,
            530,
            616,
            530,
            616,
            530,
            767.5,
            501.5,
            767.5,
            501.5,
            767.5,
            501.5,
            868,
            539,
            868,
            539,
            868,
            539,
            944.5,
            566,
            944.5,
            566,
            944.5,
            566,
            1021,
            668,
            1021,
            668,
            1021,
            668,
            1099,
            714.5,
            1099,
            714.5,
            1099,
            714.5,
            1267,
            809,
            1267,
            809,
            1267,
            809,
            1487.5,
            846.5,
            1487.5,
            846.5,
            1487.5,
            846.5,
            1649.5,
            864.5,
            1649.5,
            864.5,
            1649.5,
            864.5,
            1871.5,
            893,
            1871.5,
            893,
            1871.5,
            893,
            2008,
            903.5,
            2008,
            903.5,
            2008,
            903.5,
            2135.5,
            873.5,
            2135.5,
            873.5,
            2135.5,
            873.5,
            2314,
            879.5,
            2314,
            879.5,
            2314,
            879.5,
            2446,
            857,
            2446,
            857,
            2446,
            857,
            2519.5,
            809,
            2519.5,
            809,
            2519.5,
            809,
            2453.5,
            770,
            2453.5,
            770,
            2453.5,
            770,
            2284,
            803,
            2284,
            803,
            2284,
            803,
            2126.5,
            753.5,
            2126.5,
            753.5,
            2126.5,
            753.5,
            1985.5,
            716,
            1985.5,
            716,
            1985.5,
            716,
            1789,
            651.5,
            1789,
            651.5,
            1789,
            651.5,
            1723,
            585.5,
            1723,
            585.5,
            1723,
            585.5,
            1753,
            527,
            1753,
            527,
            1753,
            527,
            1874.5,
            431,
            1874.5,
            431,
            1874.5,
            431,
            1984,
            372.5,
            1984,
            372.5,
            1984,
            372.5,
            2098,
            300.5,
            2098,
            300.5,
            2098,
            300.5,
            2216.5,
            242,
            2216.5,
            242,
            2216.5,
            242,
            2362,
            173,
            2362,
            173,
            2362,
            173,
            2479,
            104,
            2479,
            104,
            2479,
            104,
            2578,
            63.5,
            2578,
            63.5,
            2578,
            63.5,
            2683,
            65,
            2683,
            65,
            2683,
            65,
            2770,
            83,
            2770,
            83,
            2770,
            83,
            2911,
            45.5,
            2911,
            45.5,
            2911,
            45.5,
            2980,
            26,
            2980,
            26,
            2980,
            26,
            2978.5,
            -37,
            2978.5,
            -37,
            2978.5,
            -37,
            2975.5,
            -130,
            2975.5,
            -130,
            2975.5,
            -130,
            3008.5,
            -187,
            3008.5,
            -187,
            3008.5,
            -187,
            3056.5,
            -229,
            3056.5,
            -229,
            3056.5,
            -229,
            3265,
            -278.5,
            3265,
            -278.5,
            3265,
            -278.5,
            3292,
            -352,
            3292,
            -352,
            3292,
            -352,
            3238,
            -437.5,
            3238,
            -437.5,
            3238,
            -437.5,
            3242.5,
            -491.5,
            3242.5,
            -491.5,
            3242.5,
            -491.5,
            3298,
            -590.5,
            3298,
            -590.5,
            3298,
            -590.5,
            3334,
            -689.5,
            3334,
            -689.5,
            3334,
            -689.5,
            3367,
            -769,
            3367,
            -769,
            3367,
            -769,
            3343,
            -860.5,
            3343,
            -860.5,
            3343,
            -860.5,
            3346,
            -937,
            3346,
            -937,
            3346,
            -937,
            3482.5,
            -991,
            3482.5,
            -991,
            3482.5,
            -991,
            3571,
            -1033,
            3571,
            -1033,
            3571,
            -1033,
            3577,
            -1142.5,
            3577,
            -1142.5,
            3577,
            -1142.5,
            3575.5,
            -1340.5,
            3575.5,
            -1340.5,
            3575.5,
            -1340.5,
            3412,
            -1370.5,
            3412,
            -1370.5,
            3412,
            -1370.5,
            3284.5,
            -1459,
            3284.5,
            -1459,
            3284.5,
            -1459,
            3092.5,
            -1490.5,
            3092.5,
            -1490.5,
            3092.5,
            -1490.5,
            2977,
            -1465,
            2977,
            -1465,
            2977,
            -1465,
            2830,
            -1414,
            2830,
            -1414,
            2830,
            -1414,
            2675.5,
            -1369,
            2675.5,
            -1369,
            2675.5,
            -1369,
            2569,
            -1345,
            2569,
            -1345,
            2569,
            -1345,
            2417.5,
            -1285,
            2417.5,
            -1285,
            2417.5,
            -1285,
            2299,
            -1271.5,
            2299,
            -1271.5,
            2299,
            -1271.5,
            2194,
            -1309,
            2194,
            -1309,
            2194,
            -1309,
            2077,
            -1336,
            2077,
            -1336,
            2077,
            -1336,
            1925.5,
            -1340.5,
            1925.5,
            -1340.5,
            1925.5,
            -1340.5,
            1739.5,
            -1319.5,
            1739.5,
            -1319.5,
            1739.5,
            -1319.5,
            1585,
            -1321,
            1585,
            -1321,
            1585,
            -1321,
            1505.5,
            -1279,
            1505.5,
            -1279,
            1505.5,
            -1279,
            1280.5,
            -1222,
            1280.5,
            -1222,
            1280.5,
            -1222,
            1067.5,
            -1166.5,
            1067.5,
            -1166.5,
            1067.5,
            -1166.5,
            997,
            -1096,
            997,
            -1096,
            997,
            -1096,
            889,
            -970,
            889,
            -970,
            889,
            -970,
            796,
            -904,
            796,
            -904,
            796,
            -904,
            694,
            -857.5,
            694,
            -857.5,
            694,
            -857.5,
            566.5,
            -854.5,
            566.5,
            -854.5,
            566.5,
            -854.5,
            499,
            -884.5,
            499,
            -884.5,
            499,
            -884.5,
            373,
            -926.5,
            373,
            -926.5,
            373,
            -926.5,
            247,
            -964,
            247,
            -964,
            247,
            -964,
            119.5,
            -977.5,
            119.5,
            -977.5,
            119.5,
            -977.5,
            -12.5,
            -949,
            -12.5,
            -949,
            -12.5,
            -949,
            -170,
            -937,
            -170,
            -937,
            -170,
            -937,
            -444.5,
            -925,
            -444.5,
            -925,
            -444.5,
            -925,
            -507.5,
            -940,
            -507.5,
            -940,
            -507.5,
            -940,
            -669.5,
            -952,
            -669.5,
            -952,
            -669.5,
            -952,
            -752,
            -1000,
            -752,
            -1000,
            -752,
            -1000,
            -956,
            -1021,
            -956,
            -1021,
            -956,
            -1021,
            -1106,
            -1031.5,
            -1106,
            -1031.5,
            -1106,
            -1031.5,
            -1212.5,
            -971.5,
            -1212.5,
            -971.5,
            -1212.5,
            -971.5,
            -1274,
            -896.5,
            -1274,
            -896.5,
            -1274,
            -896.5,
            -1412,
            -886,
            -1412,
            -886,
            -1412,
            -886,
            -1512.5,
            -841,
            -1512.5,
            -841,
            -1512.5,
            -841,
            -1592,
            -787,
            -1592,
            -787,
            -1592,
            -787,
            -1667,
            -785.5,
            -1667,
            -785.5,
            -1667,
            -785.5,
            -1826,
            -797.5,
            -1826,
            -797.5,
            -1826,
            -797.5,
            -1929.5,
            -733,
            -1929.5,
            -733,
            -1929.5,
            -733,
            -2012,
            -736,
            -2012,
            -736,
            -2012,
            -736,
            -2136.5,
            -773.5,
            -2136.5,
            -773.5,
            -2136.5,
            -773.5,
            -2270,
            -787,
            -2270,
            -787,
            -2270,
            -787,
            -2420,
            -806.5,
            -2420,
            -806.5,
            -2420,
            -806.5,
            -2526.5,
            -857.5,
            -2526.5,
            -857.5,
            -2526.5,
            -857.5,
            -2616.5,
            -863.5,
            -2616.5,
            -863.5,
            -2616.5,
            -863.5,
            -2748.5,
            -887.5,
            -2748.5,
            -887.5,
            -2748.5,
            -887.5,
            -2819,
            -920.5,
            -2819,
            -920.5,
            -2819,
            -920.5,
            -2961.5,
            -907,
            -2961.5,
            -907,
            -2961.5,
            -907,
            -3050,
            -913,
            -3050,
            -913,
            -3050,
            -913,
            -3150.5,
            -959.5,
            -3150.5,
            -959.5,
            -3150.5,
            -959.5,
            -3212,
            -1003,
            -3212,
            -1003,
            -3212,
            -1003,
            -3362,
            -1031.5,
            -3362,
            -1031.5,
            -3362,
            -1031.5,
            -3479,
            -1054,
            -3479,
            -1054,
            -3479,
            -1054,
            -3567.5,
            -1054,
            -3567.5,
            -1054,
            -3567.5,
            -1054,
            -3578,
            -967,
            -3578,
            -967,
            -3578,
            -967,
            -3581,
            -824.5,
            -3581,
            -824.5,
            -3581,
            -824.5
        ]
        const triangleVerticesIndexs = earcut(polygonVerticesFlat)

        this.astarGraph = new AStarGraph(flatVertexs2Vec2(polygonVerticesFlat), triangleVerticesIndexs)
        for (const triangle of this.astarGraph.trianglesMesh) {
            this.drawTriangle(this.graphicsContainer.getChildByName("mesh_graphics").getComponent(cc.Graphics), triangle)
        }

    }

    private updateViewPortMapTileNodes() {

        // 计算视口矩形
        const viewportBoundX = (0 - this.viewPort.width / 2) - this.mapContainer.x
        const viewportBoundY = (0 - this.viewPort.height / 2) - this.mapContainer.y
        const viewportRect: QuadTreeRect = { x: viewportBoundX, y: viewportBoundY, width: this.viewPort.width, height: this.viewPort.height }

        // 判断视口与地图四叉树碰撞
        const visiableTileObjects: tileMapData[] = this.mapQuadTree.retrieve(viewportRect)

        // 动态显示可视区域地图块节点
        this.mapContainer.children.forEach((node: cc.Node) => node.active = false)

        for (const tileObject of visiableTileObjects) {
            tileObject.node.active = true
            if (tileObject.node.getComponent(cc.Sprite)) continue

            cc.resources.load(tileObject.node.name, cc.SpriteFrame, (err, spriteFrame) => {
                tileObject.node.addComponent(cc.Sprite).spriteFrame = spriteFrame
            })
        }
    }

    private drawRect(ctx: cc.Graphics, blocks: Array<Block>, color: cc.Color = cc.Color.GREEN) {
        ctx.clear()
        for (const block of blocks) {
            const pos = this.astarGraphMesh.getPosByBlock(block)
            ctx.rect(pos.x, pos.y, 32, 32)
        }
        ctx.lineWidth = 5
        ctx.strokeColor = color
        ctx.stroke()
    }

    private drawLine(ctx: cc.Graphics, points: Array<cc.Vec2>, color: cc.Color = cc.Color.BLACK) {

        ctx.moveTo(points[0].x, points[0].y)
        for (let i = 1; i < points.length; i++) {
            ctx.lineTo(points[i].x, points[i].y)
        }
        ctx.lineWidth = 5
        ctx.strokeColor = color
        ctx.stroke()
    }

    private drawTriangle(ctx: cc.Graphics, triangle: Triangle, color: cc.Color = cc.Color.RED) {
        const vertice1 = triangle.vertices[0]
        const vertice2 = triangle.vertices[1]
        const vertice3 = triangle.vertices[2]
        ctx.moveTo(vertice1.x, vertice1.y)
        ctx.lineTo(vertice2.x, vertice2.y)
        ctx.lineTo(vertice3.x, vertice3.y)
        ctx.lineTo(vertice1.x, vertice1.y)
        ctx.lineWidth = 5
        ctx.strokeColor = color
        ctx.stroke()
    }
}

type tileMapData = {
    owningRect: QuadTreeRect,
    node: cc.Node
}

